using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using vPret;
using Telerik.WinControls.UI;
using System.Data.SqlClient;

namespace Pret
{
    /// <summary>
    /// Tech control 
    /// </summary>
    public partial class UCTechControl : UserControl
    {
        string bQuery = @"SELECT     LOAN.LOA_ID as 'LOAID',
                                     LOAN.LOA_PROVIDER as 'Fournisseur',
                                     LOAN.LOA_COMM_G as 'Commentaire Prêt' ,
			                         LOAN.LOA_DATE AS 'Date de contrôle',
                                     [USER].USE_USERNAME AS 'Technicien'
                                     FROM        LOAN 
                                     INNER JOIN [USER] ON LOAN.LOA_USER_ID_FK = [USER].USE_ID
                                     WHERE [USER].USE_USERNAME IN
                                                        ( SELECT [USER].USE_USERNAME
                                                            FROM [USER]
                                                            WHERE [USER].USE_ID = LOAN.LOA_USER_ID_FK ) 
                    ; 
                        SELECT      PRODUCT.PRO_ID as 'PROID',
                                    PRODUCT.PRO_LOA_ID_FK AS 'PROLOAIDFK',
			                        PRODUCT.PRO_NAME as 'Nom Produit', 
			                        PRODUCT.PRO_SN as 'N°Série Produit', 
			                        PRODUCT.PRO_COM as 'Commentaire Produit' 

                        FROM        PRODUCT

                    ;
                		SELECT      ACCESSORIES.ACC_NAME as 'Nom Accessoire', 
			                        ACCESSORIES.ACC_PN as 'PN Accessoire',
                                    ACCESSORIES.ACC_COM as 'Commentaire Accessoire',
                                    ACCESSORIES.ACC_PRO_ID_FK AS 'ACCPROIDFK'
                        FROM        ACCESSORIES;";

        public UCTechControl()
        {
            InitializeComponent();

            FillDataLoanToControl(bQuery);
            radGridView1.Visible = false;
            Controls.Add(label1);
            label1.Text = "EN CONSTRUCTION";
            this.Dock = DockStyle.Fill;
        }

        private void FillDataLoanToControl(string query, Dictionary<string, string> param = null)
        {
            try
            {
                using (SqlConnection con = new SqlConnection(Properties.Settings.Default.vPretConnectionString))
                {
                    con.Open();
                    using (SqlCommand cmd = new SqlCommand(query, con))
                    {
                        cmd.CommandType = CommandType.Text;
                        if (param != null)
                            foreach (KeyValuePair<string, string> sqlparam in param)
                                cmd.Parameters.Add(new SqlParameter(sqlparam.Key, sqlparam.Value));
                        using (SqlDataAdapter sda = new SqlDataAdapter(cmd))
                        {
                            using (DataSet ds = new DataSet())
                            {
                                sda.Fill(ds);
                                radGridView1.DataSource = ds.Tables[0];
                                GridViewCheckBoxColumn checkbox = new GridViewCheckBoxColumn();
                                checkbox.Name = "ValiderControle";
                                checkbox.FieldName = "ValiderControle";
                                checkbox.HeaderText = "Valider Contrôle";
                                radGridView1.MasterTemplate.Columns.Add(checkbox);
                                 
                                radGridView1.MasterTemplate.BestFitColumns();
                                radGridView1.AllowAddNewRow = false;
                                radGridView1.AllowColumnResize = true;
                                radGridView1.MasterTemplate.AutoSizeColumnsMode = GridViewAutoSizeColumnsMode.Fill;

                                /*
                                 * Here the relation between Loan & product
                                 * */
                                
                                GridViewTemplate template1 = new GridViewTemplate();
                                template1.AllowAddNewRow = false;
                                template1.DataSource = ds.Tables[1];
                                radGridView1.MasterTemplate.Templates.Add(template1);
                                GridViewRelation relation1 = new GridViewRelation(radGridView1.MasterTemplate);
                                relation1.ChildTemplate = template1;
                                relation1.RelationName = "Produit / Pret";
                                relation1.ParentColumnNames.Add("LOAID");
                                relation1.ChildColumnNames.Add("PROLOAIDFK");
                                radGridView1.Templates[0].Columns["PROLOAIDFK"].IsVisible = false;
                                radGridView1.Templates[0].Columns["PROID"].IsVisible = false;
                                radGridView1.Templates[0].AllowAutoSizeColumns = true;
                                radGridView1.Templates[0].AutoSizeColumnsMode = GridViewAutoSizeColumnsMode.Fill;
                                radGridView1.Templates[0].BestFitColumns();
                                radGridView1.Relations.Add(relation1);
                                
                                /**
                                 *   Here the relation between Product & accessories
                                 **/
                                
                                // Can't use radgridview.MasterTemplates.template for some reasons
                                
                                GridViewTemplate template2 = new GridViewTemplate();
                                template2.AllowAddNewRow = false;
                                template2.DataSource = ds.Tables[2];
                                template1.Templates.Add(template2);
                                GridViewRelation relation2 = new GridViewRelation(template1);
                                relation2.ChildTemplate = template2;
                                relation2.RelationName = "Produit / Accessoire";
                                relation2.ParentColumnNames.Add("PROID");
                                relation2.ChildColumnNames.Add("ACCPROIDFK");
                                template2.Columns["ACCPROIDFK"].IsVisible = false;
                                template2.AllowAutoSizeColumns = true;
                                template2.AutoSizeColumnsMode = GridViewAutoSizeColumnsMode.Fill;
                                template2.BestFitColumns();
                                radGridView1.Relations.Add(relation2);

                                template2.Columns["Nom Accessoire"].ReadOnly = true;
                                template2.Columns["PN Accessoire"].ReadOnly = true;
                                template2.Columns["Commentaire Accessoire"].ReadOnly = true;
                                template1.Columns["Nom Produit"].ReadOnly = true;
                                template1.Columns["N°Série Produit"].ReadOnly = true;
                                template1.Columns["Commentaire Produit"].ReadOnly = true;

                                template1.AllowDeleteRow = false;
                                template2.AllowDeleteRow = false;

                                radGridView1.MasterTemplate.AllowDeleteRow = false;
                                
                                foreach (GridViewColumn row in radGridView1.Columns)
                                {
                                    if (row.FieldName.Equals("ValiderControle") == false)
                                        row.ReadOnly = true;
                                }
                            }
                        }
                    }
                }
                radGridView1.MasterTemplate.AutoSizeColumnsMode = GridViewAutoSizeColumnsMode.Fill;
                radGridView1.Templates[0].AutoSizeColumnsMode = GridViewAutoSizeColumnsMode.Fill;
                this.Dock = DockStyle.Fill;
            }
            catch (Exception ex)
            {
                Log.UCTechControle.Error("FillDataPretAcontroler() - Exception: " + ex.ToString());
            }
            finally
            {
                Log.UCTechControle.Debug("FillDataPretAcontroler() : STATUT : PASSED");
            }
        }
    }
}
